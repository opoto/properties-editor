<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset='utf-8'>
  <meta http-equiv="x-ua-compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width,height=device-height, user-scalable=no" />
  <meta name="description" content="Encryption / decvryption library">
  <title>EncDec lib</title>
  <link rel="stylesheet" href="css/properties-editor.css" />
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
</head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-MYXQ3EPJND"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-MYXQ3EPJND');
</script>

<body>
  <h1>EncDec lib</h1>
  <p>
    This page demonstrates how the <a href="https://github.com/opoto/properties-editor/blob/master/js/encdec.js">EncDec Javascript library</a> works.
    It encrypts a clear text with an AES-GCM key derived from a password using PBKDF2.
    Encryption output is an encoded string in the form:
  </p>
  <p>
    <code>
      iterations#digest#key-size#salt#iv#ciphertext
    </code>
  </p>
  <p>
    The salt, iv and cipher text values are base64 encoded.
  </p>
  <p>
    Encryption is configurable:
  <ul>
    <li>
      <label>Iterations:
        <select id="enc-iter">
          <option value="10">10</option>
          <option value="100">100</option>
          <option value="1000">1000</option>
          <option value="10000">10000</option>
          <option value="100000" selected>100000</option>
          <option value="1000000">1000000</option>
          <option value="10000000">10000000</option>
        </select>
      </label>
    </li>
    <li>
      <label>Hash algo:
        <select id="enc-algo">
          <option value="SHA-1">SHA-1</option>
          <option value="SHA-256" selected>SHA-256</option>
        </select>
      </label>
    </li>
    <li>
      <label>Key size:
        <select id="enc-key-size">
          <option value="128">128</option>
          <option value="256" selected>256</option>
        </select>
      </label>
    </li>
    <li>
      Note: AES-GCM is using a random IV.
    </li>
  </ul>
  </p>
  <p>
    In addition EncDec lib includes a simple password generator, with options:
  <ul>
    <li>
      <label>Size:
        <select id="pwd-sz">
          <option value="8">8</option>
          <option value="10">10</option>
          <option value="12" selected>12</option>
          <option value="14">14</option>
          <option value="16">16</option>
          <option value="18">18</option>
          <option value="20">20</option>
        </select>
      </label>
    </li>
    <li>
      <label>Numbers <input type="checkbox" id="pwd-num" checked/></label> [0-9]
    </li>
    <li>
      <label>Alphabet <input type="checkbox" id="pwd-alpha" checked/></label> [a-zA-Z]
    </li>
    <li>
      <label>Symbols <input type="checkbox" id="pwd-sym" /></label> (,.!?;:&=+-*/_)
    </li>
    <li>
      <label>Allow ambiguous chars <input type="checkbox" id="pwd-ambig" /></label> (1iIlL0oO)
    </li>
  </ul>
  </p>
  <table>
    <tr>
      <td>Clear text</td>
      <td><textarea id="txt" cols="120" rows="5">This is my secret message</textarea></td>
    </tr>
    <tr>
      <td>Password(s)</td>
      <td>
        <label>Number of passwords:
          <select id="pwd-number">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
          </select>
        </label>
        <button id="genPwd">Renew</button>
        (All passwords are combined to encrypt / decrypt)
        <br/>
        <input id="pwd1" class="pwd" type="text" value="p4ssw0rd" />
        <input id="pwd2" class="pwd" type="text" value="p4ssw0rd" />
        <input id="pwd3" class="pwd" type="text" value="p4ssw0rd" />
        (Indicative strength: <span id="pwd-strength"></span>)
      </td>
    </tr>
    <tr>
      <td><button id="encBtn">Encrypt</button></td>
      <td><textarea id="enc" cols="120" rows="5"></textarea></td>
    </tr>
    <tr>
      <td><button id="decBtn">Decrypt</button></td>
      <td><textarea id="dec" cols="120" rows="5"></textarea></td>
    </tr>
  </table>
  <div id="log"></div>
  <div class="footnote">This page collects anonymous usage statistics. Passwords and texts (clear and encrypted) never leave your browser</div>
  <script src="js/encdec.js"></script>
  <script>

    // Initialize library
    const encdec = new EncDec();

    if (encdec.isCryptoSupported()) {
      $("#encBtn").on("click", doEncrypt);
      $("#decBtn").on("click", doDecrypt);
      $("#genPwd").on("click", newPassword);
      $("#pwd-number").on("change", readConfig);
      $(".pwd").on("keyup", () => { estimatePasswordStrength(readPassword());});
    } else {
      $("#log").append("<p>ERROR: crypto is not supported</p>");
      $("#encBtn").attr("disabled", "disabled");
      $("#decBtn").attr("disabled", "disabled");
    }

    let pwdConfig = {};
    let pwdSize;
    let pwdNumber;
    let encConfig = {};

    function readConfig() {

      pwdNumber = Number.parseInt($("#pwd-number").children("option:selected").val());
      $("#pwd2").toggle(pwdNumber > 1);
      $("#pwd3").toggle(pwdNumber > 2);

      pwdSize = Number.parseInt($("#pwd-sz").children("option:selected").val());
      pwdConfig.size = pwdSize * pwdNumber;
      pwdConfig.withNum = $("#pwd-num").is(":checked");
      pwdConfig.withAlpha = $("#pwd-alpha").is(":checked");
      pwdConfig.withSymbols = $("#pwd-sym").is(":checked");
      pwdConfig.allowAmbiguous = $("#pwd-ambig").is(":checked");

      encConfig = {};
      encConfig.iterations = Number.parseInt($("#enc-iter").children("option:selected").val());
      encConfig.algorithm = $("#enc-algo").children("option:selected").val();
      encConfig.keySize = Number.parseInt($("#enc-key-size").children("option:selected").val());

      console.debug("Password config: " + JSON.stringify(pwdConfig));
      console.debug("Crypto config: " + JSON.stringify(encConfig));
    }

    const passwordStrengths = ["Weak", "Medium", "Strong", "Excellent"];
    function estimatePasswordStrength(password) {
      let strength = encdec.getPasswordStrength(password);
      $("#pwd-strength").text(strength.score + " - " + passwordStrengths[strength.level]);
    }

    function readPassword() {
      let pwd = $("#pwd1").val();
      if (pwdNumber > 1) {
        pwd += $("#pwd2").val();
      }
      if (pwdNumber > 2) {
        pwd += $("#pwd3").val();
      }
      console.debug("Password: " + pwd);
      estimatePasswordStrength(pwd);
      return pwd;
    }

    async function doEncrypt() {
      readConfig();
      var txt = $("#txt").val(),
        pwd = readPassword();
      $("#log").html("");
      $("#enc").val("");
      try {
        cipher = await encdec.aesGcmEncrypt(txt, pwd, encConfig);
        $("#enc").val(cipher.encoded);
      } catch (err) {
        $("#log").append("<p>ERROR: " + err + "</p>");
      }
    }

    async function doDecrypt() {
      readConfig();
      var enc = $("#enc").val(),
        pwd = readPassword();
      $("#log").html("");
      $("#dec").val("");
      try {
        plaintext = await encdec.aesGcmDecrypt(enc, pwd, encConfig);
        $("#dec").val(plaintext.decoded);
      } catch (err) {
        $("#log").append("<p>ERROR: " + err + "</p>");
      }
    }

    async function newPassword() {
      readConfig();
      let password = encdec.generatePassword(pwdConfig);
      if (!password) {
        alert("Check at least one set of characters in the password generator options");
        return;
      }
      estimatePasswordStrength(password);
      let index = 0;
      while (index < pwdNumber) {
        let pwd = password.substr(index * pwdSize, pwdSize);
        index++;
        $("#pwd"+index).val(pwd);
      }
    }

    readConfig();
  </script>
</body>

</html>